{
  "hash": "8852929d3bc208ced4a640515b56fc6f",
  "result": {
    "markdown": "---\ntitle: \"Part 1: Processing data in GRASS\"\nauthor: Ver√≥nica Andreo\nformat: \n  html: \n    code-tools: true\n    code-copy: true\n    code-fold: false\n---\n\nIn this notebook we'll go through the processing of MODIS LST daily time series\ndata to derive relevant predictor variables for modeling the distribution of\n*Aedes albopictus* in Northern Italy. Furthermore, we'll show how to obtain and\nprocess occurrence data and background points.\n\nLet's first go through some temporal concepts within GRASS GIS...\n\n\n## The TGRASS framework\n\nGRASS GIS was the first FOSS GIS that incorporated capabilities to \n*manage, analyze, process and visualize spatio-temporal data*, as well as \nthe temporal relationships among time series.\n\n- TGRASS is fully **based on metadata** and does not duplicate any dataset\n- **Snapshot** approach, i.e., adds time stamps to maps\n- A collection of time stamped maps (snapshots) of the same variable are called **space-time datasets** or STDS\n- Maps in a STDS can have different spatial and temporal extents\n- Space-time datasets can be composed of raster, raster 3D or vector maps, and so\nwe call them:\n  - Space time raster datasets (**STRDS**)\n  - Space time 3D raster datasets (**STR3DS**)\n  - Space time vector datasets (**STVDS**)\n\n\n## Temporal modules\n\nGRASS temporal modules are named and organized following GRASS core naming\nscheme. In this way, we have:\n\n- **t.\\***: General modules to handle STDS of all types\n- **t.rast.\\***: Modules that deal with STRDS\n- **t.rast3d.\\***: Modules that deal with STR3DS\n- **t.vect.\\***: Modules that deal with STVDS\n\n\n### Other TGRASS notions\n\n- Time can be defined as **intervals** (start and end time) or **instances** \n(only start time)\n- Time can be **absolute** (e.g., 2017-04-06 22:39:49) or **relative** \n(e.g., 4 years, 90 days)\n- **Granularity** is the greatest common divisor of the temporal extents \n(and possible gaps) of all maps in the space-time cube\n\n<img src=\"https://grass.osgeo.org/grass78/manuals/timeline_2D.jpg\" width=\"50%\" align=\"center\"/>\n\n- **Topology** refers to temporal relations between time intervals in a STDS.\n\n<img src=\"assets/img/studio/temp_relation.png\" width=\"40%\"/>\n\n\n### TGRASS framework and workflow\n\n<img src=\"assets/img/studio/tgrass_flowchart.png\" width=\"70%\" align=\"center\"/>\n\n## Hands-on, let's start\n\nSo let's start...\n\n::: {.cell execution_count=1}\n``` {.python .cell-code}\nimport os\nimport sys\n\n# data directory\nhomedir = os.path.join(os.path.expanduser('~'), \"grass_ncsu_2023\")\n\n# GRASS GIS database variables\ngrassbin = \"grass\"\ngrassdata = os.path.join(homedir, \"grassdata\")\nlocation = \"nc_spm_08_grass7\"\nmapset = \"PERMANENT\"\n\n# create directories if not already existing\nos.makedirs(grassdata, exist_ok=True)\n```\n:::\n\n\n::: {.cell execution_count=2}\n``` {.python .cell-code}\nimport subprocess\nprint(subprocess.check_output([grassbin, \"--config\", \"version\"], text=True))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n8.2.0\n\n```\n:::\n:::\n\n\n::: {.cell execution_count=3}\n``` {.python .cell-code}\n# Ask GRASS GIS where its Python packages are \nsys.path.append(\n    subprocess.check_output([grassbin, \"--config\", \"python_path\"], text=True).strip()\n)\n```\n:::\n\n\n::: {.cell execution_count=4}\n``` {.python .cell-code}\n# Import the GRASS GIS packages we need\nimport grass.script as gs\nimport grass.jupyter as gj\n\n# Start the GRASS GIS Session\nsession = gj.init(grassdata, location, mapset)\n```\n:::\n\n\n::: {.cell execution_count=5}\n``` {.python .cell-code}\n# List vector elements in the PERMANENT mapset\ngs.list_grouped(type=\"vector\")\n```\n\n::: {.cell-output .cell-output-display execution_count=5}\n```\n{'PERMANENT': ['P079214',\n  'P079215',\n  'P079218',\n  'P079219',\n  'basins_10k',\n  'boundary_county',\n  'boundary_municp',\n  'boundary_wake',\n  'bridges',\n  'busroute1',\n  'busroute11',\n  'busroute6',\n  'busroute_a',\n  'busroutesall',\n  'busstopsall',\n  'census_wake2000',\n  'censusblk_swwake',\n  'comm_colleges',\n  'elev_lid792_bepts',\n  'elev_lid792_cont1m',\n  'elev_lid792_randpts',\n  'elev_lidrural_mrpts',\n  'elev_lidrural_mrptsft',\n  'elev_ned10m_cont10m',\n  'firestations',\n  'geodetic_pts',\n  'geodetic_swwake_pts',\n  'geology',\n  'geonames_NC',\n  'geonames_wake',\n  'hospitals',\n  'lakes',\n  'my_firestations',\n  'myrailroads',\n  'myzipcodes_wake',\n  'nc_limites',\n  'nc_state',\n  'ortho_tiles',\n  'output_points',\n  'overpasses',\n  'poi_names_wake',\n  'precip_30ynormals',\n  'precip_30ynormals_3d',\n  'puntos_escuelas',\n  'railroads',\n  'region_elevation',\n  'region_nc',\n  'roadsmajor',\n  'schools_wake',\n  'soils_general',\n  'soils_wake',\n  'streams',\n  'streets_wake',\n  'swwake_10m',\n  'tmp_current_point',\n  'tmp_points',\n  'uniform_com_colleges',\n  'urbanarea',\n  'usgsgages',\n  'zipcodes_wake']}\n```\n:::\n:::\n\n\n::: {.cell execution_count=6}\n``` {.python .cell-code}\nimport folium\n```\n:::\n\n\n::: {.cell execution_count=7}\n``` {.python .cell-code}\n# Display newly created vector\nmap1 = gj.Map(width=500, use_region=True)\nmap1.d_vect(map=\"railroads\")\nmap1.show()\n```\n\n::: {.cell-output .cell-output-display execution_count=7}\n![](notebook_ex_rs_grass_files/figure-html/cell-8-output-1.png){}\n:::\n:::\n\n\n#### Importing species records\n\n::: {.panel-tabset}\n\n## GRASS code\n\n\n```{bash}\n# Import records\nv.import input=aedes_albopictus.gpkg \n  output=aedes_albopictus\n\n# List raster maps\ng.list type=raster\nr.colors map=lst_2014.150_avg color=celsius\n\n# Display records\nd.mon wx0\nd.rast lst_2014.150_avg\nd.vect aedes_albopictus icon=basic/circle \\\n  size=7 fill_color=black\n```\n\n\n## Map\n<img src=\"assets/img/wx0_aedes_lst.png\" width=\"500px\">\n\n:::\n\nYou can also get the occurrences directly from GBIF into GRASS\nby means of [v.in.pygbif](https://grass.osgeo.org/grass-stable/manuals/addons/v.in.pygbif.html).\n\n\n#### Creating random background points\n\n::: {.panel-tabset}\n\n## GRASS code\n\n\n```{bash}\n# Create buffer around Aedes albopictus records\nv.buffer input=aedes_albopictus output=aedes_buffer distance=2000\n\n# Set computational region\ng.region -p raster=lst_2014.001_avg\n\n# Create a vector mask to limit background points\nr.mapcalc expression=\"MASK = if(lst_2014.001_avg, 1, null())\"\nr.to.vect input=MASK output=vect_mask type=area\n\n# Subtract buffers from vector mask\nv.overlay ainput=vect_mask binput=aedes_buffer operator=xor output=mask_bg\n\n# Generate random background points\nv.random output=background_points npoints=1000 restrict=mask_bg seed=3749\n```\n\n\n## Map\n\n<img src=\"assets/img/points_aedes_background.png\" width=\"500px\">\n\n:::\n\nSee extra slides for details about [*computational region*](#region) and [*masks*](#mask) in GRASS GIS.\n\n\n#### Create daily LST STRDS\n\n::: {.panel-tabset}\n\n## GRASS code\n\n\n```{bash}\n# Create time series \nt.create type=strds temporaltype=absolute \\\n  output=lst_daily title=\"Average Daily LST\" \\\n  description=\"Average daily LST in degree C - 2014-2018\"\n\n# Get list of maps \ng.list type=raster pattern=\"lst_201*\" output=list_lst.csv\n\n# Register maps in strds  \nt.register -i input=lst_daily file=list_lst.csv \\\n  increment=\"1 days\" start=\"2014-01-01\"\n\n# Get info about the strds\nt.info input=lst_daily\n```\n\n\n## Output\n\n<img src=\"assets/img/t_info_output.png\" width=\"50%\">\n\n:::\n\nSee [t.create](https://grass.osgeo.org/grass-stable/manuals/t.create.html) and [t.register](https://grass.osgeo.org/grass-stable/manuals/t.register.html)\n\n\n### Generate environmental variables from LST STRDS\n\n#### Long term monthly avg, min and max LST\n\n::: {.panel-tabset}\n\n## GRASS code\n\n\n```{bash}\nfor i in $(seq -w 1 12) ; do \n  t.rast.series input=lst_daily method=average \\\n    where=\"strftime('%m', start_time)='${i}'\" \\\n    output=lst_average_${i}\n  t.rast.series input=lst_daily method=minimum \\\n    where=\"strftime('%m', start_time)='${i}'\" \\\n    output=lst_minimum_${i}\n  t.rast.series input=lst_daily method=maximum \\\n    where=\"strftime('%m', start_time)='${i}'\" \\\n    output=lst_maximum_${i}  \ndone\n```\n\n\n## Output\n\n<img src=\"assets/img/list_long_term_avg_lst.png\" width=\"70%\">\n\n:::\n\nSee [t.rast.series](https://grass.osgeo.org/grass-stable/manuals/t.rast.series.html) manual for further details.\n\n\n#### Bioclimatic variables\n\n::: {.panel-tabset}\n\n## GRASS code\n\n\n```{bash}\n# Install extension\ng.extension extension=r.bioclim\n \n# Estimate temperature related bioclimatic variables\nr.bioclim \\\n  tmin=$(g.list type=raster pattern=\"lst_minimum_??\" separator=\",\") \\\n  tmax=$(g.list type=raster pattern=\"lst_maximum_??\" separator=\",\") \\\n  tavg=$(g.list type=raster pattern=\"lst_average_??\" separator=\",\") \\\n  output=worldclim_ \n\n# List output maps\ng.list type=raster pattern=\"worldclim*\"\n```\n\n\n## Output\n<img src=\"assets/img/list_worldclim_lst.png\" width=\"80%\">\n\n## Map\n\n<img src=\"assets/img/bio1.png\" width=\"50%\">\n\n:::\n\nSee [r.bioclim](https://grass.osgeo.org/grass-stable/manuals/addons/r.bioclim.html) manual for further details.\n\n\n#### Spring warming\n\n::: {.panel-tabset}\n\n## GRASS code\n\n\n```{bash}\n# Annual spring warming: slope(daily Tmean february-march-april)\nt.rast.aggregate input=lst_daily output=annual_spring_warming \\\n  basename=spring_warming suffix=gran \\\n  method=slope granularity=\"1 years\" \\\n  where=\"strftime('%m',start_time)='02' or \\\n         strftime('%m',start_time)='03' or \\\n         strftime('%m', start_time)='04'\"\n\n# Average spring warming\nt.rast.series input=annual_spring_warming \\\n  output=avg_spring_warming \\\n  method=average\n```\n\n\n## Map\n\n<img src=\"assets/img/spring_warming.png\" width=\"50%\">\n\n:::\n\nSee [t.rast.aggregate](https://grass.osgeo.org/grass-stable/manuals/t.rast.aggregate.html) manual.\n\n\n#### Autumnal cooling\n\n::: {.panel-tabset}\n\n## GRASS code\n\n\n```{bash}\n# Annual autumnal cooling: slope(daily Tmean august-september-october)\nt.rast.aggregate input=lst_daily output=annual_autumnal_cooling \\\n  basename=autumnal_cooling suffix=gran \\\n  method=slope granularity=\"1 years\" \\\n  where=\"strftime('%m',start_time)='08' or \\\n         strftime('%m',start_time)='09' or \\\n         strftime('%m', start_time)='10'\"\n\n# Average autumnal cooling\nt.rast.series input=annual_autumnal_cooling \\\n  output=avg_autumnal_cooling \\\n  method=average\n```\n\n\n## Map\n\n<img src=\"assets/img/autumnal_cooling.png\" width=\"51%\">\n\n:::\n\n\n#### Number of days with LSTmean >= 20 and <= 30\n\n::: {.panel-tabset}\n\n## GRASS code\n\n```bash\n# Keep only pixels meeting the condition\nt.rast.algebra -n \\\n  expression=\"tmean_higher20_lower30 = if(lst_daily >= 20.0 && lst_daily <= 30.0, 1, null())\" \\\n  basename=tmean_higher20_lower30 suffix=gran nproc=7\n\n# Count how many times per year the condition is met\nt.rast.aggregate input=tmean_higher20_lower30 \\\n  output=count_tmean_higher20_lower30 \\\n  basename=tmean_higher20_lower30 suffix=gran \\\n  method=count granularity=\"1 years\"\n\n# Average number of days with LSTmean >= 20 and <= 30\nt.rast.series input=count_tmean_higher20_lower30 \\\n  output=avg_count_tmean_higher20_lower30 method=average\n```\n\n## Map\n\n<img src=\"assets/img/count_days_higher20_lower30.png\" width=\"50%\">\n\n:::\n\nSee [t.rast.algebra](https://grass.osgeo.org/grass-stable/manuals/t.rast.algebra.html) manual for further details.\n\n\n#### Number of consecutive days with LSTmean <= -2.0\n\n\n```bash\n# Create annual mask\nt.rast.aggregate input=lst_daily output=annual_mask \\\n  basename=annual_mask suffix=gran \\\n  granularity=\"1 year\" method=count\n\n# Replace values by zero\nt.rast.mapcalc input=annual_mask output=annual_mask_0 \\\n  expression=\"if(annual_mask, 0)\" \\\n  basename=annual_mask_0\n\n# Calculate consecutive days with LST <= -2.0\nt.rast.algebra \\\n  expression=\"lower_m2_consec_days = annual_mask_0 {+,contains,l} \\\n  if(lst_daily <= -2.0 && lst_daily[-1] <= -2.0 || \\\n  lst_daily[1] <= -2.0 && lst_daily <= -2.0, 1, 0)\" \\\n  basename=lower_m2_ suffix=gran nproc=7\n```\n\n\n```bash\n# Inspect values\nt.rast.list input=lower_m2_consec_days \\\n  columns=name,start_time,end_time,min,max\n\n# Median number of consecutive days with LST <= -2\nt.rast.series input=lower_m2_consec_days \\\n  output=median_lower_m2_consec_days method=median\n```\n\n<img src=\"assets/img/median_days_lower_m2.png\" width=\"60%\">\n\n\nWe have all these maps within GRASS, how do we connect with R now? Let's move to #part2\n\n",
    "supporting": [
      "notebook_ex_rs_grass_files/figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}